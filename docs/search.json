[
  {
    "objectID": "Final.html",
    "href": "Final.html",
    "title": "1. Data Analysis",
    "section": "",
    "text": "Show code\nimport os\nos.getcwd()\n\n\n'/Users/cccskye103/Desktop/Python_Final'\nShow code\nfrom pathlib import Path\nimport pandas as pd\nimport geopandas as gpd\nimport requests\n\nBASE_DIR = Path(\".\").resolve()\n\nDATA_DIR = BASE_DIR / \"Data\"\nRAW_DIR = DATA_DIR / \"raw\"\nPROCESSED_DIR = DATA_DIR / \"processed\"\n\nprint(\"Base directory:\", BASE_DIR)\nprint(\"Raw directory:\", RAW_DIR)\n\nlist(RAW_DIR.iterdir())\n\n\nBase directory: /Users/cccskye103/Desktop/Python_Final\nRaw directory: /Users/cccskye103/Desktop/Python_Final/Data/raw\n\n\n[PosixPath('/Users/cccskye103/Desktop/Python_Final/Data/raw/Census_Block_Groups_2010.geojson'),\n PosixPath('/Users/cccskye103/Desktop/Python_Final/Data/raw/indego-trips-2023-q4.csv'),\n PosixPath('/Users/cccskye103/Desktop/Python_Final/Data/raw/indego-trips-2023-q3-2.csv'),\n PosixPath('/Users/cccskye103/Desktop/Python_Final/Data/raw/indego-trips-2023-q1.csv'),\n PosixPath('/Users/cccskye103/Desktop/Python_Final/Data/raw/indego-trips-2023-q2.csv')]\nShow code\nbg_path = RAW_DIR / \"Census_Block_Groups_2010.geojson\"\nprint(\"Block group file exists:\", bg_path.exists())\n\nblock_groups = gpd.read_file(bg_path)\n\nprint(\"Number of block groups:\", len(block_groups))\nprint(\"CRS:\", block_groups.crs)\nblock_groups.head()\n\n\nBlock group file exists: True\nNumber of block groups: 1336\nCRS: EPSG:4326\n\n\n\n\n\n\n\n\n\nOBJECTID\nSTATEFP10\nCOUNTYFP10\nTRACTCE10\nBLKGRPCE10\nGEOID10\nNAMELSAD10\nMTFCC10\nFUNCSTAT10\nALAND10\nAWATER10\nINTPTLAT10\nINTPTLON10\nShape__Area\nShape__Length\ngeometry\n\n\n\n\n0\n1\n42\n101\n010800\n1\n421010108001\nBlock Group 1\nG5030\nS\n161887\n0\n+39.9687580\n-075.1997251\n1.742508e+06\n8200.327170\nPOLYGON ((-75.19851 39.96945, -75.19744 39.969...\n\n\n1\n2\n42\n101\n010800\n2\n421010108002\nBlock Group 2\nG5030\nS\n103778\n0\n+39.9665475\n-075.2004455\n1.117026e+06\n4364.980144\nPOLYGON ((-75.19783 39.96571, -75.20006 39.965...\n\n\n2\n3\n42\n101\n010900\n2\n421010109002\nBlock Group 2\nG5030\nS\n43724\n0\n+39.9642929\n-075.1896435\n4.706347e+05\n3048.109084\nPOLYGON ((-75.18766 39.9645, -75.18755 39.9639...\n\n\n3\n4\n42\n101\n011000\n2\n421010110002\nBlock Group 2\nG5030\nS\n108966\n0\n+39.9753585\n-075.2113476\n1.172871e+06\n5169.004282\nPOLYGON ((-75.20984 39.97351, -75.21221 39.973...\n\n\n4\n5\n42\n101\n011000\n1\n421010110001\nBlock Group 1\nG5030\nS\n142244\n0\n+39.9724202\n-075.2051689\n1.531076e+06\n10476.574129\nPOLYGON ((-75.19855 39.9733, -75.19854 39.9730...\nShow code\ntrip_files = sorted(RAW_DIR.glob(\"indego-trips-2023-q*.csv\"))\ntrip_files\n\n\n[PosixPath('/Users/cccskye103/Desktop/Python_Final/Data/raw/indego-trips-2023-q1.csv'),\n PosixPath('/Users/cccskye103/Desktop/Python_Final/Data/raw/indego-trips-2023-q2.csv'),\n PosixPath('/Users/cccskye103/Desktop/Python_Final/Data/raw/indego-trips-2023-q3-2.csv'),\n PosixPath('/Users/cccskye103/Desktop/Python_Final/Data/raw/indego-trips-2023-q4.csv')]",
    "crumbs": [
      "Analysis",
      "Data Analysis"
    ]
  },
  {
    "objectID": "Final.html#data-inspection",
    "href": "Final.html#data-inspection",
    "title": "1. Data Analysis",
    "section": "2. Data Inspection",
    "text": "2. Data Inspection\n\n\nShow code\ntrips_list = [pd.read_csv(f, low_memory=False) for f in trip_files]\ntrips = pd.concat(trips_list, ignore_index=True)\n\nprint(\"Trip rows:\", len(trips))\ntrips.head()\n\n\nTrip rows: 1084547\n\n\n\n\n\n\n\n\n\ntrip_id\nduration\nstart_time\nend_time\nstart_station\nstart_lat\nstart_lon\nend_station\nend_lat\nend_lon\nbike_id\nplan_duration\ntrip_route_category\npassholder_type\nbike_type\n\n\n\n\n0\n579507686\n70\n1/1/2023 0:00\n1/1/2023 1:10\n3063\n39.946331\n-75.169800\n3063\n39.946331\n-75.169800\n22584\n365\nRound Trip\nIndego365\nelectric\n\n\n1\n579499091\n17\n1/1/2023 0:05\n1/1/2023 0:22\n3190\n39.948921\n-75.169907\n3207\n39.954411\n-75.192001\n5281\n30\nOne Way\nIndego30\nstandard\n\n\n2\n579499089\n11\n1/1/2023 0:06\n1/1/2023 0:17\n3182\n39.950809\n-75.169533\n3102\n39.967590\n-75.179520\n22366\n30\nOne Way\nIndego30\nelectric\n\n\n3\n579499087\n1\n1/1/2023 0:08\n1/1/2023 0:09\n3026\n39.941818\n-75.145500\n3026\n39.941818\n-75.145500\n17780\n30\nRound Trip\nIndego30\nelectric\n\n\n4\n579499085\n27\n1/1/2023 0:09\n1/1/2023 0:36\n3046\n39.950119\n-75.144722\n3112\n39.953732\n-75.218246\n16897\n30\nOne Way\nIndego30\nelectric\n\n\n\n\n\n\n\n\n\nShow code\nstations_url = \"https://bts-status.bicycletransit.workers.dev/phl\"\n\nresponse = requests.get(stations_url)\nresponse.raise_for_status()\n\ndata = response.json()\nfeatures = data[\"features\"]\n\nstations_gdf = gpd.GeoDataFrame.from_features(features, crs=\"EPSG:4326\")\n\nprint(\"Station rows:\", len(stations_gdf))\nstations_gdf.head()\n\n\nStation rows: 290\n\n\n\n\n\n\n\n\n\ngeometry\nid\nname\ncoordinates\ntotalDocks\ndocksAvailable\nbikesAvailable\nclassicBikesAvailable\nsmartBikesAvailable\nelectricBikesAvailable\n...\nisEventBased\nisVirtual\nkioskId\nnotes\nopenTime\npublicText\ntimeZone\ntrikesAvailable\nlatitude\nlongitude\n\n\n\n\n0\nPOINT (-75.14403 39.94733)\n3005\nWelcome Park, NPS\n[-75.14403, 39.94733]\n13\n1\n11\n5\n0\n6\n...\nFalse\nFalse\n3005\nNone\nNone\n\nNone\n0\n39.94733\n-75.14403\n\n\n1\nPOINT (-75.20311 39.9522)\n3006\n40th & Spruce\n[-75.20311, 39.9522]\n17\n17\n0\n0\n0\n0\n...\nFalse\nFalse\n3006\nNone\nNone\n\nNone\n0\n39.95220\n-75.20311\n\n\n2\nPOINT (-75.15993 39.94517)\n3007\n11th & Pine, Kahn Park\n[-75.15993, 39.94517]\n20\n16\n3\n2\n0\n1\n...\nFalse\nFalse\n3007\nNone\nNone\n\nNone\n0\n39.94517\n-75.15993\n\n\n3\nPOINT (-75.15067 39.98081)\n3008\nTemple University Station\n[-75.15067, 39.98081]\n17\n13\n2\n1\n0\n1\n...\nFalse\nFalse\n3008\nNone\nNone\n\nNone\n0\n39.98081\n-75.15067\n\n\n4\nPOINT (-75.18982 39.95576)\n3009\n33rd & Market\n[-75.18982, 39.95576]\n14\n10\n4\n4\n0\n0\n...\nFalse\nFalse\n3009\nNone\nNone\n\nNone\n0\n39.95576\n-75.18982\n\n\n\n\n5 rows × 34 columns\n\n\n\n\n\nShow code\n# Check current CRS\nprint(\"Block groups CRS:\", block_groups.crs)\nprint(\"Stations CRS:\", stations_gdf.crs)\n\n# Use a projected CRS for Philly – Pennsylvania South feet\nTARGET_CRS = \"EPSG:2272\"\n\nbg_proj = block_groups.to_crs(TARGET_CRS)\nstations_proj = stations_gdf.to_crs(TARGET_CRS)\n\nprint(\"Reprojected CRS (block groups):\", bg_proj.crs)\nprint(\"Reprojected CRS (stations):\", stations_proj.crs)\n\n\nBlock groups CRS: EPSG:4326\nStations CRS: EPSG:4326\nReprojected CRS (block groups): EPSG:2272\nReprojected CRS (stations): EPSG:2272\n\n\n\n\nShow code\n!pip install folium\n\n\nRequirement already satisfied: folium in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (0.20.0)\nRequirement already satisfied: branca&gt;=0.6.0 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from folium) (0.8.2)\nRequirement already satisfied: jinja2&gt;=2.9 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from folium) (3.1.6)\nRequirement already satisfied: numpy in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from folium) (2.3.5)\nRequirement already satisfied: requests in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from folium) (2.32.5)\nRequirement already satisfied: xyzservices in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from folium) (2025.11.0)\nRequirement already satisfied: MarkupSafe&gt;=2.0 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from jinja2&gt;=2.9-&gt;folium) (3.0.3)\nRequirement already satisfied: charset_normalizer&lt;4,&gt;=2 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests-&gt;folium) (3.4.4)\nRequirement already satisfied: idna&lt;4,&gt;=2.5 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests-&gt;folium) (3.11)\nRequirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests-&gt;folium) (2.5.0)\nRequirement already satisfied: certifi&gt;=2017.4.17 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests-&gt;folium) (2025.11.12)\n\n\n\n\nShow code\nimport folium\n\nbg_4326 = block_groups.to_crs(\"EPSG:4326\")\nstations_4326 = stations_gdf.to_crs(\"EPSG:4326\")\n\n# create map\nm = folium.Map(\n    location=[39.9526, -75.1652],\n    zoom_start=12,\n    tiles=\"CartoDB positron\"\n)\n\n# block groups\nfolium.GeoJson(\n    bg_4326,\n    name=\"block_groups\",\n    style_function=lambda feature: {\n        \"fillColor\": \"#e0e0e0\",\n        \"color\": \"#b0b0b0\",\n        \"weight\": 0.5,\n        \"fillOpacity\": 0.15,\n    },\n).add_to(m)\n\n# stations\nfor _, row in stations_4326.iterrows():\n    folium.CircleMarker(\n        location=[row.geometry.y, row.geometry.x],\n        radius=4,\n        color=\"#1f78b4\",\n        fill=True,\n        fill_color=\"#1f78b4\",\n        fill_opacity=0.9,\n    ).add_to(m)\n\n# -------------------------------------------------------\n# LEGEND (custom HTML)\n# -------------------------------------------------------\nlegend_html = \"\"\"\n&lt;div style=\"\n    position: fixed; \n    bottom: 25px; left: 25px; width: 180px; \n    background: white; z-index: 9999; \n    padding: 10px; border: 2px solid #ccc; \n    font-size: 13px;\n\"&gt;\n&lt;b&gt;Legend&lt;/b&gt;&lt;br&gt;\n&lt;span style=\"background:#e0e0e0; border:1px solid #b0b0b0; \n      width:14px; height:14px; display:inline-block;\"&gt;&lt;/span&gt;\n&nbsp; Block Groups&lt;br&gt;\n\n&lt;span style=\"background:#1f78b4; border-radius:50%; \n      width:12px; height:12px; display:inline-block;\"&gt;&lt;/span&gt;\n&nbsp; Bike Stations\n&lt;/div&gt;\n\"\"\"\n\nm.get_root().html.add_child(folium.Element(legend_html))\n\nm\n\n\n\nMake this Notebook Trusted to load map: File -&gt; Trust Notebook\n\n\n\n\nShow code\n!pip install censusdata\nimport censusdata\n\n\nRequirement already satisfied: censusdata in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (1.15.post1)\nRequirement already satisfied: pandas in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from censusdata) (2.3.3)\nRequirement already satisfied: requests in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from censusdata) (2.32.5)\nRequirement already satisfied: numpy&gt;=1.23.2 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from pandas-&gt;censusdata) (2.3.5)\nRequirement already satisfied: python-dateutil&gt;=2.8.2 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from pandas-&gt;censusdata) (2.9.0.post0)\nRequirement already satisfied: pytz&gt;=2020.1 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from pandas-&gt;censusdata) (2025.2)\nRequirement already satisfied: tzdata&gt;=2022.7 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from pandas-&gt;censusdata) (2025.2)\nRequirement already satisfied: six&gt;=1.5 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from python-dateutil&gt;=2.8.2-&gt;pandas-&gt;censusdata) (1.17.0)\nRequirement already satisfied: charset_normalizer&lt;4,&gt;=2 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests-&gt;censusdata) (3.4.4)\nRequirement already satisfied: idna&lt;4,&gt;=2.5 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests-&gt;censusdata) (3.11)\nRequirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests-&gt;censusdata) (2.5.0)\nRequirement already satisfied: certifi&gt;=2017.4.17 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests-&gt;censusdata) (2025.11.12)\n\n\n\n\nShow code\n# variables we want\nacs_vars = [\n    'B01003_001E',  # total population\n    'B19013_001E',  # median income\n    'B02001_002E',  # white\n    'B02001_003E',  # black\n    'B02001_005E',  # asian\n    'B03003_003E',  # hispanic\n    'B25044_003E',  # zero vehicle households\n    'B08301_018E',  # bicycle commuters\n]\n\n# download ACS 2023 5-year block group data for Philadelphia County (FIPS: 42101)\nacs_2023 = censusdata.download(\n    'acs5', \n    2023, \n    censusdata.censusgeo([('state', '42'), ('county', '101'), ('block group', '*')]),\n    acs_vars\n)\n\nacs_2023.head()\n\n\n\n\n\n\n\n\n\nB01003_001E\nB19013_001E\nB02001_002E\nB02001_003E\nB02001_005E\nB03003_003E\nB25044_003E\nB08301_018E\n\n\n\n\nBlock Group 1; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:1\n0\n-666666666\n0\n0\n0\n0\n0\n0\n\n\nBlock Group 2; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:2\n0\n-666666666\n0\n0\n0\n0\n0\n0\n\n\nBlock Group 3; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:3\n0\n-666666666\n0\n0\n0\n0\n0\n0\n\n\nBlock Group 4; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:4\n1138\n107172\n894\n47\n46\n154\n23\n0\n\n\nBlock Group 5; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:5\n858\n122917\n831\n0\n27\n13\n85\n0\n\n\n\n\n\n\n\n\n\nShow code\nacs_2023['GEOID'] = acs_2023.index.to_series().apply(\n    lambda x: x.geo[2][1] + x.geo[3][1]  # tract + block group codes\n)\n\n\n\n\nShow code\nacs_2023.head()\n\n\n\n\n\n\n\n\n\nB01003_001E\nB19013_001E\nB02001_002E\nB02001_003E\nB02001_005E\nB03003_003E\nB25044_003E\nB08301_018E\nGEOID\n\n\n\n\nBlock Group 1; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:1\n0\n-666666666\n0\n0\n0\n0\n0\n0\n0001011\n\n\nBlock Group 2; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:2\n0\n-666666666\n0\n0\n0\n0\n0\n0\n0001012\n\n\nBlock Group 3; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:3\n0\n-666666666\n0\n0\n0\n0\n0\n0\n0001013\n\n\nBlock Group 4; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:4\n1138\n107172\n894\n47\n46\n154\n23\n0\n0001014\n\n\nBlock Group 5; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:5\n858\n122917\n831\n0\n27\n13\n85\n0\n0001015\n\n\n\n\n\n\n\n\n\nShow code\nblock_groups.columns\n\n\nIndex(['OBJECTID', 'STATEFP10', 'COUNTYFP10', 'TRACTCE10', 'BLKGRPCE10',\n       'GEOID10', 'NAMELSAD10', 'MTFCC10', 'FUNCSTAT10', 'ALAND10', 'AWATER10',\n       'INTPTLAT10', 'INTPTLON10', 'Shape__Area', 'Shape__Length', 'geometry'],\n      dtype='object')\n\n\n\n\nShow code\ndef make_geoid_full(x):\n    # x.geo is a list of geography components:\n    # [('state', '42'), ('county', '101'), ('tract', '000100'), ('block group', '1')]\n    state = x.geo[0][1]      # '42'\n    county = x.geo[1][1]     # '101'\n    tract = x.geo[2][1]      # '000100'\n    blkgrp = x.geo[3][1]     # '1'\n    \n    return state + county + tract + blkgrp\n\nacs_2023['GEOID'] = acs_2023.index.to_series().apply(make_geoid_full)\n\n\n\n\nShow code\nacs_2023['GEOID'].head()\n\n\nBlock Group 1; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:1    421010001011\nBlock Group 2; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:2    421010001012\nBlock Group 3; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:3    421010001013\nBlock Group 4; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:4    421010001014\nBlock Group 5; Census Tract 1.01; Philadelphia County; Pennsylvania: Summary level: 150, state:42&gt; county:101&gt; tract:000101&gt; block group:5    421010001015\nName: GEOID, dtype: object\n\n\n\n\nShow code\nblock_groups = block_groups.rename(columns={'GEOID10': 'GEOID'})\n\n\n\n\nShow code\nblock_groups_acs = block_groups.merge(\n    acs_2023,\n    on='GEOID',\n    how='left'\n)\n\n\n\n\nShow code\nblock_groups_acs = block_groups_acs.replace(\n    [-666666666, -666666667, -222222222],\n    pd.NA\n)\n\n\n\n\nShow code\nblock_groups_acs[['B01003_001E', 'B19013_001E', 'B02001_003E']].describe()\n\n\n\n\n\n\n\n\n\nB01003_001E\nB02001_003E\n\n\n\n\ncount\n1151.000000\n1151.000000\n\n\nmean\n1248.841008\n522.159861\n\n\nstd\n650.884279\n525.509607\n\n\nmin\n0.000000\n0.000000\n\n\n25%\n789.000000\n102.000000\n\n\n50%\n1120.000000\n385.000000\n\n\n75%\n1605.000000\n792.000000\n\n\nmax\n4265.000000\n3684.000000\n\n\n\n\n\n\n\n\n\nShow code\nbg_proj['centroid'] = bg_proj.geometry.centroid\nbg_centroids = bg_proj.set_geometry('centroid')\n\n\n\n\nShow code\nnearest = bg_centroids.sjoin_nearest(\n    stations_proj[['geometry']],\n    how='left',\n    distance_col='dist_to_station_ft'\n)\n\n\n\n\nShow code\nbg_proj['dist_to_station_ft'] = nearest['dist_to_station_ft'].values\n\n\n\n\nShow code\nbg_proj['dist_to_station_ft'].describe()\n\n\ncount     1336.000000\nmean     10318.505472\nstd      12921.454684\nmin          0.701145\n25%        918.895354\n50%       3654.985911\n75%      16798.387059\nmax      59632.188947\nName: dist_to_station_ft, dtype: float64\n\n\n\n\nShow code\nbg_proj = bg_proj.to_crs(\"EPSG:2272\")\nstations_proj = stations_gdf.to_crs(\"EPSG:2272\")\n\nbg_proj['centroid'] = bg_proj.geometry.centroid\nbg_centroids = bg_proj.set_geometry('centroid')\n\nbuffer_400m = 400 * 3.28084\nbuffer_800m = 800 * 3.28084\n\nbg_centroids['buffer_400m'] = bg_centroids.buffer(buffer_400m)\nbg_centroids['buffer_800m'] = bg_centroids.buffer(buffer_800m)    # Compute 400m & 800m buffers\n\n\n\n\nShow code\nstations_points = stations_proj[['geometry']].copy()\n\n\n\n\nShow code\nbg_400 = gpd.sjoin(\n    bg_centroids.set_geometry('buffer_400m'),\n    stations_points,\n    how='left',\n    predicate='contains'\n)\n\ncount_400 = bg_400.groupby(bg_400.index).size().rename('stations_within_400m')\n\n\n\n\nShow code\nbg_800 = gpd.sjoin(\n    bg_centroids.set_geometry('buffer_800m'),\n    stations_points,\n    how='left',\n    predicate='contains'\n)\n\ncount_800 = bg_800.groupby(bg_800.index).size().rename('stations_within_800m')\n\n\n\n\nShow code\nbg_proj['stations_within_400m'] = count_400.reindex(bg_proj.index).fillna(0)\nbg_proj['stations_within_800m'] = count_800.reindex(bg_proj.index).fillna(0)\n\n\n\n\nShow code\nbg_proj[['stations_within_400m', 'stations_within_800m']].describe()\n\n\n\n\n\n\n\n\n\nstations_within_400m\nstations_within_800m\n\n\n\n\ncount\n1336.000000\n1336.000000\n\n\nmean\n1.413922\n3.459581\n\n\nstd\n1.082410\n4.518776\n\n\nmin\n1.000000\n1.000000\n\n\n25%\n1.000000\n1.000000\n\n\n50%\n1.000000\n1.000000\n\n\n75%\n1.000000\n4.000000\n\n\nmax\n10.000000\n31.000000\n\n\n\n\n\n\n\n\n\nShow code\nimport matplotlib.pyplot as plt\nfig, ax = plt.subplots(figsize=(8,8))\nbg_proj.plot(\n    column='stations_within_800m',\n    ax=ax,\n    legend=True,\n    cmap='Blues',\n    linewidth=0.1,\n    edgecolor='grey'\n)\nax.set_title(\"Stations Within 800m\")\nax.set_axis_off()\nplt.show()\n\n\n\n\n\n\n\n\n\n\n\nShow code\nimport matplotlib.pyplot as plt\n\nfig, ax = plt.subplots(figsize=(8,8))\n\nbg_proj.plot(\n    column='stations_within_400m',\n    ax=ax,\n    legend=True,\n    cmap='PuRd',          # ← warm orange-red\n    linewidth=0.1,\n    edgecolor='grey'\n)\n\nax.set_title(\"Stations Within 400m\")\nax.set_axis_off()\n\nplt.show()\n\n\n\n\n\n\n\n\n\n\n\n\nShow code\nfig, ax = plt.subplots(figsize=(8,8))\nbg_proj.plot(\n    column='dist_to_station_ft',\n    ax=ax,\n    legend=True,\n    cmap='OrRd',\n    linewidth=0.1,\n    edgecolor='grey'\n)\nax.set_title(\"Distance to Nearest Indego Station (ft)\")\nax.set_axis_off()\nplt.show()\n\n\n\n\n\n\n\n\n\n\n\nShow code\n!pip install osmnx\n\n\nRequirement already satisfied: osmnx in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (2.0.7)\nRequirement already satisfied: geopandas&gt;=1.0.1 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from osmnx) (1.1.1)\nRequirement already satisfied: networkx&gt;=2.5 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from osmnx) (3.6)\nRequirement already satisfied: numpy&gt;=1.22 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from osmnx) (2.3.5)\nRequirement already satisfied: pandas&gt;=1.4 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from osmnx) (2.3.3)\nRequirement already satisfied: requests&gt;=2.27 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from osmnx) (2.32.5)\nRequirement already satisfied: shapely&gt;=2.0 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from osmnx) (2.1.2)\nRequirement already satisfied: pyogrio&gt;=0.7.2 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from geopandas&gt;=1.0.1-&gt;osmnx) (0.12.1)\nRequirement already satisfied: packaging in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from geopandas&gt;=1.0.1-&gt;osmnx) (25.0)\nRequirement already satisfied: pyproj&gt;=3.5.0 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from geopandas&gt;=1.0.1-&gt;osmnx) (3.7.2)\nRequirement already satisfied: python-dateutil&gt;=2.8.2 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from pandas&gt;=1.4-&gt;osmnx) (2.9.0.post0)\nRequirement already satisfied: pytz&gt;=2020.1 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from pandas&gt;=1.4-&gt;osmnx) (2025.2)\nRequirement already satisfied: tzdata&gt;=2022.7 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from pandas&gt;=1.4-&gt;osmnx) (2025.2)\nRequirement already satisfied: certifi in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from pyogrio&gt;=0.7.2-&gt;geopandas&gt;=1.0.1-&gt;osmnx) (2025.11.12)\nRequirement already satisfied: six&gt;=1.5 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from python-dateutil&gt;=2.8.2-&gt;pandas&gt;=1.4-&gt;osmnx) (1.17.0)\nRequirement already satisfied: charset_normalizer&lt;4,&gt;=2 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests&gt;=2.27-&gt;osmnx) (3.4.4)\nRequirement already satisfied: idna&lt;4,&gt;=2.5 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests&gt;=2.27-&gt;osmnx) (3.11)\nRequirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /opt/anaconda3/envs/pyfinal/lib/python3.11/site-packages (from requests&gt;=2.27-&gt;osmnx) (2.5.0)\n\n\n\n\nShow code\nimport osmnx as ox\nimport geopandas as gpd\n\n# 让 osmnx 使用缓存（更快）\nox.settings.use_cache = True\nox.settings.log_console = True\n\n# 定义你想抓的区域 —— 用 city name 最简单\nplace = \"Philadelphia, Pennsylvania, USA\"\n\n# 抓取只包含“骑行可通行”的道路 (highway in cycleway/bike priority)\nG = ox.graph_from_place(place, network_type='bike')\n\n# 转成 GeoDataFrame\nbike_edges = ox.graph_to_gdfs(G, nodes=False, edges=True)\n\n# 投影成与分析一致的坐标系 (feet)\nbike_edges = bike_edges.to_crs(2272)\n\nbike_edges.head()\n\n\n\n\n\n\n\n\n\n\n\nosmid\nhighway\nname\noneway\nreversed\nlength\nlanes\nmaxspeed\nservice\ngeometry\naccess\nref\nbridge\nwidth\ntunnel\njunction\narea\n\n\nu\nv\nkey\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n109726936\n109726940\n0\n12108955\nresidential\nBrunner Street\nTrue\nFalse\n174.382306\nNaN\nNaN\nNaN\nLINESTRING (2695094.618 260318.14, 2694612.512...\nNaN\nNaN\nNaN\nNaN\nNaN\nNaN\nNaN\n\n\n109992543\n0\n43226669\nprimary\nGermantown Avenue\nFalse\nFalse\n55.073821\n2\n25 mph\ndisused_tram\nLINESTRING (2695094.618 260318.14, 2695013.384...\nNaN\nNaN\nNaN\nNaN\nNaN\nNaN\nNaN\n\n\n109992535\n0\n43226669\nprimary\nGermantown Avenue\nFalse\nTrue\n7.177834\n2\n25 mph\ndisused_tram\nLINESTRING (2695094.618 260318.14, 2695105.597...\nNaN\nNaN\nNaN\nNaN\nNaN\nNaN\nNaN\n\n\n109726940\n109726950\n0\n302956448\nresidential\nWayne Avenue\nFalse\nFalse\n11.447633\nNaN\nNaN\nNaN\nLINESTRING (2694612.512 260008.562, 2694632.74...\nNaN\nNaN\nNaN\nNaN\nNaN\nNaN\nNaN\n\n\n110047495\n0\n302956448\nresidential\nWayne Avenue\nFalse\nTrue\n34.627130\nNaN\nNaN\nNaN\nLINESTRING (2694612.512 260008.562, 2694551.30...\nNaN\nNaN\nNaN\nNaN\nNaN\nNaN\nNaN\n\n\n\n\n\n\n\n\n\nShow code\n# nearest bike lane for each centroid (you already ran this)\nnearest_bike = bg_centroids.sjoin_nearest(\n    bike_edges,\n    how='left',\n    distance_col='dist_to_bikelane_ft'\n)\n\n# 1. take the MIN distance per block group (group by index)\ndist_to_bike = nearest_bike.groupby(nearest_bike.index)['dist_to_bikelane_ft'].min()\n\n# 2. align back to bg_proj by index\nbg_proj['dist_to_bikelane_ft'] = dist_to_bike.reindex(bg_proj.index)\n\n# 3. convert to meters\nbg_proj['dist_to_bikelane_m'] = bg_proj['dist_to_bikelane_ft'] * 0.3048\n\nbg_proj['dist_to_bikelane_ft'].describe()\n\n\ncount    1336.000000\nmean       49.287174\nstd        80.870854\nmin         0.040906\n25%         9.850038\n50%        28.640869\n75%        60.698483\nmax      1592.880493\nName: dist_to_bikelane_ft, dtype: float64\n\n\n\n\nShow code\nbg_proj = block_groups_acs.to_crs(\"EPSG:2272\").copy()\n\nbg_proj.columns\n\n\nIndex(['OBJECTID', 'STATEFP10', 'COUNTYFP10', 'TRACTCE10', 'BLKGRPCE10',\n       'GEOID', 'NAMELSAD10', 'MTFCC10', 'FUNCSTAT10', 'ALAND10', 'AWATER10',\n       'INTPTLAT10', 'INTPTLON10', 'Shape__Area', 'Shape__Length', 'geometry',\n       'B01003_001E', 'B19013_001E', 'B02001_002E', 'B02001_003E',\n       'B02001_005E', 'B03003_003E', 'B25044_003E', 'B08301_018E'],\n      dtype='object')\n\n\n\n\nShow code\nimport pandas as pd\nimport numpy as np\n\ndef minmax(series):\n    # convert to numeric, turn bad values into NaN\n    s = pd.to_numeric(series, errors=\"coerce\")\n    s_min = s.min()\n    s_max = s.max()\n    return (s - s_min) / (s_max - s_min)\n\n\n\n\nShow code\n# total population\npop = pd.to_numeric(bg_proj['B01003_001E'], errors='coerce')\n\n# race: white + nonwhite share\nwhite = pd.to_numeric(bg_proj['B02001_002E'], errors='coerce')\npct_nonwhite = 1 - (white / pop.replace(0, np.nan))\n\n# income\nmedian_income = pd.to_numeric(bg_proj['B19013_001E'], errors='coerce')\n\n# zero-vehicle households\nzero_vehicle = pd.to_numeric(bg_proj['B25044_003E'], errors='coerce').fillna(0)\n\n# scaled need components (0–1, 1 = higher need)\n# income: higher need = lower income → invert after scaling\nincome_scaled = minmax(median_income)\nneed_income = 1 - income_scaled\n\nneed_nonwhite = minmax(pct_nonwhite)\nneed_zero_vehicle = minmax(zero_vehicle)\n\n# combined need score\nbg_proj['need_score'] = (need_income + need_nonwhite + need_zero_vehicle) / 3\n\nbg_proj['need_score'].describe()\n\n\ncount    912.000000\nmean       0.492663\nstd        0.148497\nmin        0.051067\n25%        0.371835\n50%        0.515928\n75%        0.611262\nmax        0.956303\nName: need_score, dtype: float64\n\n\n\n\nShow code\nplt.figure(figsize=(7,4))\nbg_proj['need_score'].plot.hist(bins=30, color='steelblue', edgecolor='white')\nplt.title(\"Distribution of Need Score\")\nplt.xlabel(\"Need Score (0–1)\")\nplt.ylabel(\"Count\")\nplt.show()\n\n\n\n\n\n\n\n\n\n\n\nShow code\nfig, ax = plt.subplots(figsize=(8,8))\nbg_proj.plot(\n    column='need_score',\n    ax=ax,\n    legend=True,\n    cmap='Purples',\n    linewidth=0.1,\n    edgecolor='grey'\n)\nax.set_title(\"Need Score Across Philadelphia\")\nax.set_axis_off()\nplt.show()\n\n\n\n\n\n\n\n\n\n\n\nShow code\n# make sure everything is in the projected CRS\nbg_proj = bg_proj.to_crs(\"EPSG:2272\").copy()\nstations_proj = stations_gdf.to_crs(\"EPSG:2272\").copy()\n\n# centroids\nbg_proj[\"centroid\"] = bg_proj.geometry.centroid\nbg_centroids = bg_proj.set_geometry(\"centroid\")\n\n# ---------- distance to nearest station ----------\nnearest_station = bg_centroids.sjoin_nearest(\n    stations_proj[[\"geometry\"]],\n    how=\"left\",\n    distance_col=\"dist_to_station_ft\"\n)\n\n# take MIN distance per BG (group by index)\ndist_to_station = nearest_station.groupby(nearest_station.index)[\"dist_to_station_ft\"].min()\nbg_proj[\"dist_to_station_ft\"] = dist_to_station.reindex(bg_proj.index)\n\n# ---------- station counts within 400m / 800m ----------\nbuffer_400 = 400 * 3.28084   # m → ft\nbuffer_800 = 800 * 3.28084\n\nbg_centroids[\"buffer_400m\"] = bg_centroids.buffer(buffer_400)\nbg_centroids[\"buffer_800m\"] = bg_centroids.buffer(buffer_800)\n\nstations_points = stations_proj[[\"geometry\"]].copy()\n\n# 400m\nbg_400 = gpd.sjoin(\n    bg_centroids.set_geometry(\"buffer_400m\"),\n    stations_points,\n    how=\"left\",\n    predicate=\"contains\"\n)\ncount_400 = bg_400.groupby(bg_400.index).size()\n\n# 800m\nbg_800 = gpd.sjoin(\n    bg_centroids.set_geometry(\"buffer_800m\"),\n    stations_points,\n    how=\"left\",\n    predicate=\"contains\"\n)\ncount_800 = bg_800.groupby(bg_800.index).size()\n\nbg_proj[\"stations_within_400m\"] = count_400.reindex(bg_proj.index).fillna(0)\nbg_proj[\"stations_within_800m\"] = count_800.reindex(bg_proj.index).fillna(0)\n\n# ---------- distance to nearest bike lane (if you already have edges) ----------\n# (skip this block if you haven't built `edges` with osmnx yet)\ntry:\n    bike_edges = edges[[\"geometry\"]].copy()\n\n    nearest_bike = bg_centroids.sjoin_nearest(\n        bike_edges,\n        how=\"left\",\n        distance_col=\"dist_to_bikelane_ft\"\n    )\n\n    dist_to_bike = nearest_bike.groupby(nearest_bike.index)[\"dist_to_bikelane_ft\"].min()\n    bg_proj[\"dist_to_bikelane_ft\"] = dist_to_bike.reindex(bg_proj.index)\nexcept NameError:\n    print(\"No `edges` bike network yet – skipping bike-lane distance.\")\n\n\n\n\n\nShow code\nbg_proj[[\"stations_within_800m\", \"dist_to_station_ft\"]].head()\n\n\n\n\n\n\n\n\n\nstations_within_800m\ndist_to_station_ft\n\n\n\n\n0\n4\n1696.105745\n\n\n1\n5\n913.283763\n\n\n2\n6\n1059.242742\n\n\n3\n2\n1028.181373\n\n\n4\n2\n2217.695798\n\n\n\n\n\n\n\n\n\nShow code\nstations800 = pd.to_numeric(bg_proj[\"stations_within_800m\"], errors=\"coerce\")\ndist_station = pd.to_numeric(bg_proj[\"dist_to_station_ft\"], errors=\"coerce\")\ndist_bikelane = pd.to_numeric(bg_proj[\"dist_to_bikelane_ft\"], errors=\"coerce\")\n\nacc_stations800 = minmax(stations800)\nacc_dist_station = minmax(-dist_station)      # closer = better = bigger value\nacc_dist_bikelane = minmax(-dist_bikelane)    # closer = better\n\nbg_proj[\"access_score\"] = (acc_stations800 + acc_dist_station + acc_dist_bikelane) / 3\nbg_proj[\"access_score\"].describe()\n\n\ncount    1336.000000\nmean        0.626014\nstd         0.107260\nmin         0.257061\n25%         0.561131\n50%         0.635703\n75%         0.691031\nmax         0.984606\nName: access_score, dtype: float64\n\n\n\n\nShow code\nplt.figure(figsize=(7,4))\nbg_proj['access_score'].plot.hist(bins=30, color='seagreen', edgecolor='white')\nplt.title(\"Distribution of Access Score\")\nplt.xlabel(\"Access Score (0–1)\")\nplt.ylabel(\"Count\")\nplt.show()\n\n\n\n\n\n\n\n\n\n\n\nShow code\nfig, ax = plt.subplots(figsize=(8,8))\n\nbg_proj.plot(\n    column='access_score',\n    ax=ax,\n    legend=True,\n    cmap='Greens',\n    linewidth=0.1,\n    edgecolor='grey'\n)\n\nax.set_title(\"Access Score Across Philadelphia\", fontsize=14)\nax.set_axis_off()\n\nplt.show()\n\n\n\n\n\n\n\n\n\n\n\nShow code\nplt.figure(figsize=(6,6))\nplt.scatter(bg_proj['access_score'], bg_proj['need_score'], alpha=0.4)\nplt.xlabel(\"Access Score\")\nplt.ylabel(\"Need Score\")\nplt.title(\"Need vs Access for Philadelphia Block Groups\")\nplt.axline((0,0),(1,1), color='red', linestyle='--')\nplt.show()\n\n\n\n\n\n\n\n\n\n\n\nShow code\nbg_proj[\"equity_gap\"] = bg_proj[\"need_score\"] - bg_proj[\"access_score\"]\nbg_proj[\"equity_gap\"].describe()\n\n\ncount    912.000000\nmean      -0.127183\nstd        0.180849\nmin       -0.713378\n25%       -0.248470\n50%       -0.067707\n75%        0.006950\nmax        0.311099\nName: equity_gap, dtype: float64\n\n\n\n\nShow code\nimport pandas as pd\n\nbg_proj['equity_gap_q'] = pd.qcut(\n    bg_proj['equity_gap'],\n    q=4,\n    labels=['Lowest gap', 'Low–medium', 'Medium–high', 'Highest gap']\n)\n\nbg_proj['equity_gap_q'].value_counts()\n\n\nequity_gap_q\nLowest gap     228\nLow–medium     228\nMedium–high    228\nHighest gap    228\nName: count, dtype: int64\n\n\n\n\nShow code\nimport folium\n\n# convert BG data to EPSG:4326\nbg_4326 = bg_proj.to_crs(\"EPSG:4326\").copy()\n\ncolor_map = {\n    'Lowest gap': '#2166ac',\n    'Low–medium': '#67a9cf',\n    'Medium–high': '#fddbc7',\n    'Highest gap': '#b2182b'\n}\n\nm = folium.Map(location=[39.9526, -75.1652], zoom_start=11, tiles='CartoDB positron')\n\ndef style_func(feature):\n    cat = feature['properties']['equity_gap_q']\n    return {\n        'fillColor': color_map.get(cat, '#cccccc'),\n        'color': '#555555',\n        'weight': 0.3,\n        'fillOpacity': 0.7,\n    }\n\nfolium.GeoJson(\n    bg_4326[['GEOID', 'equity_gap', 'equity_gap_q', 'geometry']],\n    style_function=style_func,\n    tooltip=folium.GeoJsonTooltip(\n        fields=['GEOID', 'equity_gap', 'equity_gap_q'],\n        aliases=['GEOID', 'Equity gap', 'Category'],\n        localize=True\n    )\n).add_to(m)\n\n# ---- Add Legend ----\nlegend_html = \"\"\"\n&lt;div style=\"\n    position: fixed; \n    bottom: 30px; left: 30px; width: 200px; \n    border:2px solid grey; z-index:9999; font-size:14px;\n    background-color:white; padding: 10px;\n\"&gt;\n&lt;b&gt;Equity Gap Legend&lt;/b&gt;&lt;br&gt;\n&nbsp;&lt;i style=\"background:#b2182b;width:12px;height:12px;float:left;margin-right:5px\"&gt;&lt;/i&gt; Highest gap&lt;br&gt;\n&nbsp;&lt;i style=\"background:#fddbc7;width:12px;height:12px;float:left;margin-right:5px\"&gt;&lt;/i&gt; Medium–high&lt;br&gt;\n&nbsp;&lt;i style=\"background:#67a9cf;width:12px;height:12px;float:left;margin-right:5px\"&gt;&lt;/i&gt; Low–medium&lt;br&gt;\n&nbsp;&lt;i style=\"background:#2166ac;width:12px;height:12px;float:left;margin-right:5px\"&gt;&lt;/i&gt; Lowest gap&lt;br&gt;\n&lt;/div&gt;\n\"\"\"\n\nm.get_root().html.add_child(folium.Element(legend_html))\n\nm\n\n\nMake this Notebook Trusted to load map: File -&gt; Trust Notebook\n\n\n\n\nShow code\nimport folium\nimport branca\n\n# 1. 把 block group 投到 WGS84，只保留需要的列\nbg_4326 = bg_proj.to_crs(4326).copy()\nbg_4326 = bg_4326[[\n    \"GEOID\",\n    \"need_score\",\n    \"access_score\",\n    \"equity_gap\",\n    \"equity_gap_q\",\n    \"geometry\",\n]].dropna(subset=[\"need_score\", \"access_score\", \"equity_gap\"])\n\n# 2. station 也转成 WGS84\nstations_4326 = stations_gdf.to_crs(4326).copy()\n\n# 3. 建一个以 Philly 为中心的底图\nm = folium.Map(\n    location=[39.9526, -75.1652],\n    zoom_start=11,\n    tiles=\"CartoDB positron\"\n)\n\n# ---------------------------------------------------------\n# 1) NEED SCORE LAYER\n# ---------------------------------------------------------\nneed_cmap = branca.colormap.linear.Purples_09.scale(\n    bg_4326[\"need_score\"].min(),\n    bg_4326[\"need_score\"].max()\n)\n\ndef style_need(feature):\n    val = feature[\"properties\"].get(\"need_score\")\n    return {\n        \"fillColor\": need_cmap(val) if val is not None else \"#cccccc\",\n        \"color\": \"#555555\",\n        \"weight\": 0.2,\n        \"fillOpacity\": 0.7,\n    }\n\nneed_layer = folium.FeatureGroup(name=\"Need score\", show=True)\n\nfolium.GeoJson(\n    data=bg_4326[[\"GEOID\", \"need_score\", \"geometry\"]],\n    style_function=style_need,\n    tooltip=folium.GeoJsonTooltip(\n        fields=[\"GEOID\", \"need_score\"],\n        aliases=[\"GEOID\", \"Need score\"],\n        localize=True,\n    ),\n).add_to(need_layer)\n\nneed_layer.add_to(m)\n\n# ---------------------------------------------------------\n# 2) ACCESS SCORE LAYER\n# ---------------------------------------------------------\nacc_cmap = branca.colormap.linear.Greens_09.scale(\n    bg_4326[\"access_score\"].min(),\n    bg_4326[\"access_score\"].max()\n)\n\ndef style_access(feature):\n    val = feature[\"properties\"].get(\"access_score\")\n    return {\n        \"fillColor\": acc_cmap(val) if val is not None else \"#cccccc\",\n        \"color\": \"#555555\",\n        \"weight\": 0.2,\n        \"fillOpacity\": 0.7,\n    }\n\naccess_layer = folium.FeatureGroup(name=\"Access score\", show=False)\n\nfolium.GeoJson(\n    data=bg_4326[[\"GEOID\", \"access_score\", \"geometry\"]],\n    style_function=style_access,\n    tooltip=folium.GeoJsonTooltip(\n        fields=[\"GEOID\", \"access_score\"],\n        aliases=[\"GEOID\", \"Access score\"],\n        localize=True,\n    ),\n).add_to(access_layer)\n\naccess_layer.add_to(m)\n\n# ---------------------------------------------------------\n# 3) EQUITY GAP LAYER  (need_score - access_score)\n# ---------------------------------------------------------\ngap_cmap = branca.colormap.linear.RdYlBu_11.scale(\n    bg_4326[\"equity_gap\"].min(),\n    bg_4326[\"equity_gap\"].max()\n)\n\ndef style_gap(feature):\n    val = feature[\"properties\"].get(\"equity_gap\")\n    return {\n        \"fillColor\": gap_cmap(val) if val is not None else \"#cccccc\",\n        \"color\": \"#555555\",\n        \"weight\": 0.2,\n        \"fillOpacity\": 0.7,\n    }\n\ngap_layer = folium.FeatureGroup(name=\"Equity gap (need − access)\", show=False)\n\nfolium.GeoJson(\n    data=bg_4326[[\"GEOID\", \"equity_gap\", \"equity_gap_q\", \"geometry\"]],\n    style_function=style_gap,\n    tooltip=folium.GeoJsonTooltip(\n        fields=[\"GEOID\", \"equity_gap\", \"equity_gap_q\"],\n        aliases=[\"GEOID\", \"Equity gap\", \"Gap category\"],\n        localize=True,\n    ),\n).add_to(gap_layer)\n\ngap_layer.add_to(m)\n\n# ---------------------------------------------------------\n# 4) STATIONS LAYER\n# ---------------------------------------------------------\nstations_layer = folium.FeatureGroup(name=\"Indego stations\", show=True)\n\nfor _, row in stations_4326.iterrows():\n    folium.CircleMarker(\n        location=[row.geometry.y, row.geometry.x],\n        radius=3,\n        fill=True,\n        fill_opacity=0.9,\n        weight=0,\n    ).add_to(stations_layer)\n\nstations_layer.add_to(m)\n\n# ---------------------------------------------------------\n# 5) LAYER CONTROL + TEXT LEGEND\n# ---------------------------------------------------------\nfolium.LayerControl(collapsed=False).add_to(m)\n\nlegend_html = \"\"\"\n&lt;div style=\"\n    position: fixed;\n    bottom: 30px; left: 30px; width: 260px;\n    border:2px solid grey; z-index:9999; font-size:13px;\n    background-color:white; padding: 10px;\n\"&gt;\n&lt;b&gt;Map layers&lt;/b&gt;&lt;br&gt;\nNeed score: darker purple = higher social need.&lt;br&gt;\nAccess score: darker green = better bike and station access.&lt;br&gt;\nEquity gap: red = lower need and/or better access; blue = higher need with lower access.&lt;br&gt;\nUse the layer control (top right) to switch between layers.\n&lt;/div&gt;\n\"\"\"\nm.get_root().html.add_child(folium.Element(legend_html))\n\nm\n\n\nMake this Notebook Trusted to load map: File -&gt; Trust Notebook\n\n\n\n\nShow code\nimport folium\n\n# 1. 转成 WGS84，并且只保留需要的列\nbg_4326 = bg_proj.to_crs(4326).copy()\n\nbg_4326 = bg_4326[[\n    \"GEOID\",\n    \"need_score\",\n    \"access_score\",\n    \"equity_gap\",\n    \"B19013_001E\",          # median income\n    \"stations_within_800m\",\n    \"geometry\"\n]].dropna(subset=[\"equity_gap\"])\n\n# 2. 选 equity_gap 最大的前 5 个 block group\ntop5 = bg_4326.sort_values(\"equity_gap\", ascending=False).head(5).copy()\ntop5[\"priority_rank\"] = range(1, len(top5) + 1)\n\n# 给每个 rank 一个颜色\nrank_colors = {\n    1: \"#d73027\",  # 深红\n    2: \"#fc8d59\",  # 橙红\n    3: \"#fee08b\",  # 浅黄\n    4: \"#91bfdb\",  # 浅蓝\n    5: \"#4575b4\",  # 深蓝\n}\n\n# 3. 地图中心\ncenter = [39.9526, -75.1652]\nm_top5 = folium.Map(location=center, zoom_start=11, tiles=\"CartoDB positron\")\n\n# 4. 底图：所有 block group 淡灰色\nfolium.GeoJson(\n    bg_4326.__geo_interface__,\n    style_function=lambda feat: {\n        \"fillColor\": \"#dddddd\",\n        \"color\": \"#aaaaaa\",\n        \"weight\": 0.3,\n        \"fillOpacity\": 0.3,\n    },\n    name=\"All block groups\"\n).add_to(m_top5)\n\n# 5. Top 5：不同颜色，带 popup\nfor _, row in top5.iterrows():\n    rank = int(row[\"priority_rank\"])\n    color = rank_colors.get(rank, \"#d73027\")  # fallback\n\n    gjson = folium.GeoJson(\n        row[\"geometry\"].__geo_interface__,\n        style_function=lambda feat, color=color: {\n            \"fillColor\": color,\n            \"color\": color,\n            \"weight\": 2,\n            \"fillOpacity\": 0.6,\n        }\n    )\n\n    popup_html = f\"\"\"\n    &lt;b&gt;Priority rank:&lt;/b&gt; {rank}&lt;br&gt;\n    &lt;b&gt;GEOID:&lt;/b&gt; {row['GEOID']}&lt;br&gt;\n    &lt;b&gt;Need score:&lt;/b&gt; {row['need_score']:.2f}&lt;br&gt;\n    &lt;b&gt;Access score:&lt;/b&gt; {row['access_score']:.2f}&lt;br&gt;\n    &lt;b&gt;Equity gap:&lt;/b&gt; {row['equity_gap']:.3f}&lt;br&gt;\n    &lt;b&gt;Median income:&lt;/b&gt; ${row['B19013_001E']:.0f}&lt;br&gt;\n    &lt;b&gt;Stations within 800 m:&lt;/b&gt; {row['stations_within_800m']:.0f}\n    \"\"\"\n    gjson.add_child(folium.Popup(popup_html, max_width=260))\n    gjson.add_to(m_top5)\n\n# 6. Legend\nlegend_html = \"\"\"\n&lt;div style=\"\n    position: fixed;\n    bottom: 25px; left: 25px; width: 240px;\n    background: white; z-index: 9999;\n    padding: 10px; border: 2px solid #ccc;\n    font-size: 13px;\n\"&gt;\n&lt;b&gt;Legend&lt;/b&gt;&lt;br&gt;\n\n&lt;span style=\"background:#dddddd; border:1px solid #aaaaaa;\n      width:14px; height:14px; display:inline-block;\"&gt;&lt;/span&gt;\n&nbsp; Other block groups&lt;br&gt;&lt;br&gt;\n\n&lt;span style=\"background:#d73027; width:14px; height:14px; display:inline-block;\"&gt;&lt;/span&gt;\n&nbsp; Priority 1 (highest equity gap)&lt;br&gt;\n\n&lt;span style=\"background:#fc8d59; width:14px; height:14px; display:inline-block;\"&gt;&lt;/span&gt;\n&nbsp; Priority 2&lt;br&gt;\n\n&lt;span style=\"background:#fee08b; width:14px; height:14px; display:inline-block;\"&gt;&lt;/span&gt;\n&nbsp; Priority 3&lt;br&gt;\n\n&lt;span style=\"background:#91bfdb; width:14px; height:14px; display:inline-block;\"&gt;&lt;/span&gt;\n&nbsp; Priority 4&lt;br&gt;\n\n&lt;span style=\"background:#4575b4; width:14px; height:14px; display:inline-block;\"&gt;&lt;/span&gt;\n&nbsp; Priority 5\n&lt;/div&gt;\n\"\"\"\n\nm_top5.get_root().html.add_child(folium.Element(legend_html))\n\nm_top5\n\n\nMake this Notebook Trusted to load map: File -&gt; Trust Notebook",
    "crumbs": [
      "Analysis",
      "Data Analysis"
    ]
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Indego Bike",
    "section": "",
    "text": "Overview\nIndego Bike",
    "crumbs": [
      "Project Overview"
    ]
  },
  {
    "objectID": "DataCleaning.html",
    "href": "DataCleaning.html",
    "title": "Data Cleaning",
    "section": "",
    "text": "This is for data cleaning",
    "crumbs": [
      "Analysis",
      "Data collection and cleaning"
    ]
  },
  {
    "objectID": "Conclusion.html",
    "href": "Conclusion.html",
    "title": "Conclusion",
    "section": "",
    "text": "This is for conclusion",
    "crumbs": [
      "Analysis",
      "Conclusion"
    ]
  }
]